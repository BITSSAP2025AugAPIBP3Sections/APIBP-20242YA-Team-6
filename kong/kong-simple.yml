# Kong Declarative Configuration
_format_version: "3.0"

services:
  - name: auth-service
    url: http://auth-service:8001
    
  - name: events-service
    url: http://events-service:8002
    
  - name: vendors-service
    url: http://vendors-service:8003
    
  - name: tasks-service
    url: http://tasks-service:8004
    
  - name: attendees-service
    url: http://attendees-service:8005
    
  - name: notifications-service
    url: http://notifications-service:8006

routes:
  # Auth - Public routes
  - name: auth-public
    service: auth-service
    paths:
      - /api/auth/login
      - /api/auth/register
    methods:
      - POST
    
  # Auth - Protected routes  
  - name: auth-protected
    service: auth-service
    paths:
      - /api/auth/profile
      - /api/auth/logout
    methods:
      - GET
      - POST
    
  # Events - Public (read-only)
  - name: events-public
    service: events-service
    paths:
      - /api/events
    methods:
      - GET
    
  # Events - Protected (write operations)
  - name: events-protected
    service: events-service
    paths:
      - /api/events
    methods:
      - POST
      - PUT
      - DELETE
    
  # All other services require authentication
  - name: vendors-all
    service: vendors-service
    paths:
      - /api/vendors
    
  - name: tasks-all
    service: tasks-service
    paths:
      - /api/tasks
    
  - name: attendees-all
    service: attendees-service
    paths:
      - /api/attendees
    
  - name: notifications-all
    service: notifications-service
    paths:
      - /api/notifications

consumers:
  - username: api-client

plugins:
  # Global CORS
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Authorization
        - Content-Type
      credentials: true

  # Global Rate Limiting
  - name: rate-limiting
    config:
      minute: 100
      hour: 1000

  # JWT for protected routes only
  - name: jwt
    route: auth-protected
    
  - name: jwt
    route: events-protected
    
  - name: jwt  
    route: vendors-all
    
  - name: jwt
    route: tasks-all
    
  - name: jwt
    route: attendees-all
    
  - name: jwt
    route: notifications-all

  # Add user context headers for services
  - name: request-transformer
    route: events-protected
    config:
      add:
        headers:
          - "X-User-ID:$(uri_captures.user_id || jwt_claim.sub)"
          - "X-User-Role:$(jwt_claim.role)"
          
  - name: request-transformer
    route: vendors-all
    config:
      add:
        headers:
          - "X-User-ID:$(uri_captures.user_id || jwt_claim.sub)"
          - "X-User-Role:$(jwt_claim.role)"
          
  - name: request-transformer
    route: tasks-all
    config:
      add:
        headers:
          - "X-User-ID:$(uri_captures.user_id || jwt_claim.sub)"
          - "X-User-Role:$(jwt_claim.role)"
          
  - name: request-transformer
    route: attendees-all
    config:
      add:
        headers:
          - "X-User-ID:$(uri_captures.user_id || jwt_claim.sub)"
          - "X-User-Role:$(jwt_claim.role)"